# Pinterest
Pinterest — социальный интернет-сервис, фотохостинг, который позволяет пользователям находить, сохранять и выкладывать изображения и видео. 

## Аудитория
MAU - 522М  
DAU - 142M

| **Страна**               | **Количество пользователей (в миллионах)** |
|--------------------------|--------------------------------------------|
| США                      | 89.9                                       |
| Бразилия                 | 38.9                                       |
| Мексика                  | 24.7                                       |
| Германия                 | 19.3                                       |
| Франция                  | 17.3                                       |
| Остальные страны         | 331.9                                      |

## Основной функционал
- Создание пинов
- Оценка пинов
- Создание досок
- Организация пинов на досках
- Просмотр ленты
- Поиск
- Регистрация/авторизация
- Подписка на пользователя

## Продуктовые метрики

| **Метрика**                | **Значение**                             |
|----------------------------|------------------------------------------|
| Создание новых пинов       | 1.5 млрд в неделю                        |
| Всего создано пинов        | >500 млрд                                |
| Всего создано досок        | >10 млрд                                 |
| Время в приложении в месяц | 1 час 49 минут                           |
| Время в приложении в день  | 2 минуты 11 секунд                       |
| Рост аудитории             | 11% с 2024 по 2025 год                   |
| Ежедневная аудитория       | 27.2% от MAU                             |


## Расчет нагрузки

### RPS
~220 пинов за сессиию в 2 минуты<br>
20 пинов за один запрос<br>
~1 новая доска в месяц (некоторые пользователи создают часто, некоторые вообще не создают новые)<br>
Переход на страницу для 1 из 20 пинов<br>
3 Поиска за сессию<br>

| **Запрос**               | **RPS**                         |
|--------------------------|---------------------------------|
| Запрос пинов для ленты   | (142m * 220/20) / 86400 = 18000 |
| Создание нового пина     | (1.5b / 7) / 86400 = 2480       |
| Создание новой доски     | (522m / 30) / 86400 = 200       |
| Добавление пина на доску | (142m * 5) / 86400 = 8220       |
| Оценка пина              | (142m * 2) / 86400 = 3290       |
| Подписка на пользователя | (522m / 30) / 86400 = 200       |
| Переход на страницу пина | (142m * 220/20) / 86400 = 18000 |
| Поиск                    | (142m * 3) / 86400 = 4930       |

### Нагрузка на сеть
Картинки хранятся в оптимизированном виде, их размер в среднем 150 Кб. На практике для ленты отдаются только превью картинок со средним размером ~10 Кб<br>
До оптимизации средний размер картинки ~1.5 Мб<br>
Поиск несет такую же нагрузку, как и основная лента, т.е. также загружает по 20 превью картинок

| **Запрос**               | **Объем трафика (Гбит/с)** |
|--------------------------|----------------------------|
| Запрос пинов для ленты   | 18000 * 10 Кб * 20 = 29.5  |
| Переход на страницу пина | 18000 * 150 Кб = 22.1      |
| Создание нового пина     | 2480 * 1.5 Мб = 31.2       |
| Создание новой доски     | 200 * 2 Кб = 0.003         |
| Добавление пина на доску | 8220 * 2 Кб = 0.135        |
| Оценка пина              | 3290 * 1 Кб = 0.027        |
| Подписка на пользователя | 200 * 1 Кб = 0.001         |
| Поиск                    | 4930 * 10 Кб * 20 = 8.1    |
| Суммарная нагрузка       | 91 Гбит/с                  |


### Занятое место на диске

Картинки хранятся в оригинальном и сжатом виде, поэтому одна картинка занимает 150 Кб + 1.5 Мб
| **Сущность** | **Объем**                 |
|--------------|---------------------------|
| Пины         | 500b * 1.65Мб = 768 ПТб   |
| Доски        | 10b * 100 Кб = 931 Тб     |
| Пользователи | 600M * 100 Кб = 56 Тб     |

## Глобальная балансировка нагрузки

Весь функционал распологается на основном домене pinterest.com

### Расположение датацентров
| Расположение ДЦ 1               | Расположение ДЦ 2     | Покрываемые регионы | Доля пользователей | Обоснование                                                                                       |
|---------------------------------|-----------------------|---------------------|--------------------|---------------------------------------------------------------------------------------------------|
| Ашберн, Северная Вирджиния, США | Даллас, Техас, США    | Северная Америка    | ~23.5%             | Второй по количеству пользователей рынок, первый по среднему доходу с пользователя                |
| Амстердам, Нидерланды           | Франкфурт, Германия   | Страны Европы       | ~26%               | Первый по размеру рынок, средний доход с пользователя выше, чем в остальном мире (за вычетом США) |
| Сан-Паулу, Бразилия             | Сингапур              | Остальные регионыы  | ~50.5%             | Минимальная задержка в регионах с большой долей рынка, но низкой прибылью                         |

### Схема балансировки DNS

Логичнее всего будет использовать Geo-based DNS балансировку, для обеспечения наибольшей надежности и низкой задержки в основных регионах

## Локальная балансировка нагрузки

Суммарный RPS: 18,000 + 2,480 + 200 + 8,220 + 3,290 + 200 + 18,000 + 4,930 = 55,520 RPS<br>
Пиковый RPS: 55,520 × 3 = 166,560 RPS (коэффициент пиковой нагрузки)<br>
Пиковый трафик: 91 Гбит/с × 3 = 273 Гбит/с<br>


Для оркестрации контейнеров и управления жизненным циклом сервисов используем Kubernetes.<br>
При запуске нового экземпляра сервиса Kubernetes создаёт контейнер и проверяет с помощью health check. Если контейнер падает или перестаёт отвечать, Kubernetes перезапускает его. Auto Scaling на основе метрик (CPU, памяти, custom metrics) динамически масштабирует количество подов.


Будем использовать балансировку на уровне приложений (L7) через NGINX как основной механизм распределения внешнего HTTP/HTTPS-трафика к сервисам в Kubernetes-кластере (в кластере работает стандартный балансировщик L4).

NGINX обеспечивает:
- SSL терминацию (через session tickets)
- Решение проблемы медленного клиента
- API-gateway функциональность
- Балансировку нагрузки Round Robin/Least Connections
- Сбор логов и timeout на 99.9%
- Rate limiting и защиту от DDoS


### Расчет количества балансировщиков:

По данным NGINX: 2 × Xeon 2699v4 обрабатывают ~9,871 RPS для запросов 100Кб.
Пиковый RPS на дата-центр: 166,560 / 6 ≈ 27,760 RPS

Требуется нод: 27,760 / 9,871 ≈ 3 рабочих ноды
С резервированием N+1: 4 ноды на дата-центр


## Логическая схема БД

![Диаграмма без названия](https://github.com/user-attachments/assets/7ffe25e1-d13c-41c8-b79e-a8813b8e5e81)

### Описание таблиц и нагрузок

| Таблица       | Назначение             | Размер строки | QPS чтение | QPS запись | Консистентность | Особенности нагрузки     |
|---------------|------------------------|---------------|------------|------------|-----------------|--------------------------|
| Users         | Профили пользователей  | 2 Кб          | 10000      | 500        | Strong          | Популярные пользователи  |
| Pins          | Данные пинов           | 2 Кб          | 100000     | 3000       | Strong          | Горячие пины             |
| Boards        | Доски пользователей    | 2 Кб          | 50000      | 200        | Strong          | Распределение по user_id |
| Tags          | Словарь тегов          | 500 Б         | 100000     | 200        | Strong          | Популярные теги          |
| Pin_Boards    | Связь пинов с досками  | 100 Б         | 50000      | 10000      | Eventual        | Связь с чтением досок    |
| Pin_Tags      | Связь пинов с тегами   | 100 Б         | 40000      | 5000       | Eventual        | Популярные теги (тренды) |
| Pin_Likes     | Лайки пинов            | 100 Б         | 100000     | 5000       | Eventual        | Связь с горячими пинами  |
| Pin_Analytics | Аналитика просмотров   | 500 Б         | 30000      | 100000     | Eventual        | Агрегация данных         |
| Follows       | Подписки пользователей | 100 Б         | 20000      | 200        | Eventual        | Двунаправленные связи    |
| Search_Index  | Поисковый индекс       | 2 Кб          | 100000     | 5000       | Eventual        | Векторные эмбеддинги     |
| Search_Cache  | Кэш поиска             | 2 Кб          | 300000     | 100000     | Eventual        | TTL-инвалидация          |
| Feed_Cache    | Кэш ленты              | 2 Кб          | 300000     | 100000     | Eventual        | TTL-инвалидация          |
| Session       | Сессии пользователей   | 1 Кб          | 10000      | 5000       | Eventual        |                          |

## Физическая схема БД

| Таблица       | СУБД          | Индексы                     | Балансировка нагрузки |
|---------------|---------------|-----------------------------|-----------------------|
| Users         | PostgreSQL    | user_id, email, username    | pgbouncer             |
| Pins          | PostgreSQL    | pin_id, user_id, created_at | pgbouncer             |
| Boards        | PostgreSQL    | board_id, user_id           | pgbouncer             |
| Tags          | PostgreSQL    | tag_id, tag, usage_count    | pgbouncer             |
| Pin_Boards    | Cassandra     | pin_id, board_id            | partition key         |
| Pin_Tags      | Cassandra     | pin_id, tag_id              | partition key         |
| Pin_Likes     | Cassandra     | pin_id, user_id             | partition key         |
| Pin_Analytics | Clickhouse    | pin_id, date                | distributed движок    |
| Follows       | PostgreSQL    | follower_id, following_id   | pgbouncer             |
| Search_Index  | Elasticsearch | по всем полям               | coordinating nodes    |
| Search_Cache  | Redis         | -                           | redis cluster         |
| Feed_Cache    | Redis         | -                           | redis cluster         |
| Session       | Redis         | user_id                     | redis cluster         |

### Схема шардинга и репликации

| Таблица       | Схема шардинга     | Количество реплик |
|---------------|--------------------|-------------------|
| Users         | user_id (range)    | 2                 |
| Pins          | pin_id (range)     | 2                 |
| Boards        | user_id (hash)     | 2                 |
| Tags          | tag_id (hash)      | 2                 |
| Pin_Boards    | (pin_id, board_id) | RF=3              |
| Pin_Tags      | (pin_id, tag_id)   | RF=3              |
| Pin_Likes     | (pin_id, user_id)  | RF=3              |
| Pin_Analytics | (pin_id, date)     | 2                 |
| Follows       | follower_id (hash) | 2                 |
| Search_Index  | pin_id (hash)      | 1                 |
| Search_Cache  | cache_key (hash)   | 1                 |
| Session       | user_id (hash)     | 2                 |


## Алгоритмы

| Алгоритм                 | Описание                                                                                             |
|--------------------------|------------------------------------------------------------------------------------------------------|
| Рекомендательная система | Алгоритм машинного обучения (например, коллаборативная фильтрация или контентная фильтрация)         |
| Алгоритмы ранжирования   | Ранжирование пинов в ленте на основе взаимодействий пользователей (например, CTR, лайки, сохранения) |
| Обработка изображений    | Алгоритмы оптимизации и сжатия изображений (например, JPEG/WebP)                                     |
| Векторный поиск          | Генерация эмбеддингов изображений и текста для семантического поиска                                 |

### Применение алгоритмов

#### Рекомендательная система
Используется для подбора наиболее привлекательных для пользователя картинок. Используется два принципа - коллаборативная фильтрация, т.е. подбор контента на основе того, что нравится людям, на которых пользователь подписан, а также контентная фильтрация - подбор контента на основе того, что уже понравилось пользователю, то есть его лайках, сохранениях и кликах

#### Алгоритмы ранжирования
Чтобы снизить нагрузку на рекомендательную систему она будет возвращать кратно большее количество подходящих пинов (к примеру для ленты будет отдаваться не 20, а 100 пинов за раз), а алгортим ранжирования будет выбирать наиболее подходящие пины. Такой же алгоритм будет использоваться и в поиске

#### Обработка изображений
Для снижения нагрузки на трафик используются современные алгоритмы сжатия изображений. Оригинальные изображения автоматически конвертируются в оптимизированные форматы (WebP/AVIF) с сохранением визуального качества при значительном уменьшении размера файла. Также генерируются превью разных размеров для различных сценариев использования - миниатюры для ленты, средние размеры для страниц пинов и оригиналы для детального просмотра.

#### Векторный поиск 
Используется для семантического поиска по визуальному контенту. Алгоритмы компьютерного зрения анализируют изображения и преобразуют их в векторные представления (эмбеддинги), которые описывают особенности контента. Это позволяет находить визуально похожие пины даже без текстовых описаний, а также комбинировать текстовые и визуальные запросы для более точного поиска. Алгоритм учитывает цветовые схемы, композицию, стиль и объекты на изображениях.

## Технологии

| Технология         | Область применения                          | Обоснование выбора                                                                                     |
|--------------------|---------------------------------------------|--------------------------------------------------------------------------------------------------------|
| PostgreSQL         | Основные данные (пользователи, пины, доски) | ACID-транзакции, надежность, богатый функционал SQL для сложных запросов                               |
| Cassandra          | Связующие таблицы (лайки, теги, пины-доски) | Линейная масштабируемость, высокая доступность, отказоустойчивость для данных с eventual consistency   |
| Redis              | Кэширование поиска и сессий                 | In-memory производительность, низкая задержка (<1ms), поддержка TTL для кэширования                    |
| Elasticsearch      | Поисковый индекс                            | Полнотекстовый поиск, высокая скорость индексации и поиска                                             |
| ClickHouse         | Аналитика просмотров                        | Колоночная СУБД, высокая скорость агрегации больших объемов данных аналитики                           |
| FAISS              | Векторный поиск                             | Оптимизированные алгоритмы поиска ближайших соседей для семантического поиска по эмбеддингам           |
| TensorFlow Serving | ML модели рекомендаций                      | Высокопроизводительное обслуживание моделей, канареечные деплои, версионирование                       |
| Graphite/Grafana   | Мониторинг и метрики                        | Полнофункциональный мониторинг, богатые возможности визуализации, интеграция с Kubernetes              |
| PGBouncer          | Connection pooling для PostgreSQL           | Снижение нагрузки на БД, эффективное управление соединениями для высоких QPS                           |
| FFMPEG             | Сжатие изображений                          | Современные форматы с лучшим качеством/размером, поддержка прозрачности и анимации                     |
| CLIP               | Генерация эмбеддингов                       | Мультимодальная модель для совместного эмбеддинга изображений и текста                                 |
| Docker             | Контейнеризация приложений                  | Стандартизация деплоя, изоляция окружений, быстрое развертывание                                       |
| Kubernetes         | Оркестрация микросервисов                   | Автоматическое масштабирование, self-healing, эффективное управление ресурсами                         |
| NGINX              | L7 балансировщик нагрузки                   | Высокая производительность, SSL termination, API gateway, защита от DDoS                               |
| Graphite, Grafana  | Сбор и визуализация метрик                  | Эффективное и простое решение                                                                          |

## Обеспечение надежности

Система построена с избыточностью на каждом уровне:
- Географическое резервирование: Использование трёх пар дата-центров в формате Active-Active, что позволяет минимизировать задержки для 80% аудитории и обеспечивает автоматическое переключение трафика (failover) при выходе из строя целого региона.
- Резервирование приложений: Все микросервисы (развернутые в Kubernetes) и балансировщики работают по схеме N+1, где N — минимально необходимое количество инстансов для обработки пиковой нагрузки.
- Автоматическое восстановление: Kubernetes обеспечивает механизмы Self-Healing (самовосстановления) через Liveness и Readiness Probes, автоматически перезапуская неисправные поды. Горизонтальное масштабирование гарантирует, что даже при потере части серверов система быстро восполнит вычислительные мощности.
- Резервирование данных: Критические данные (PostgreSQL) используют комбинацию синхронных реплик для обеспечения целостности (Strong Consistency) и асинхронных реплик для Disaster Recovery. Распределенные базы данных (Cassandra, ClickHouse, Elasticsearch) используют высокий коэффициент репликации (RF $\ge 2$) для сохранения доступности при потере отдельных узлов.

| Компонент                                  | Технология               | Уровень избыточности     | Основной механизм резервирования                        | Схема восстановления                                                                      |
|--------------------------------------------|--------------------------|--------------------------|---------------------------------------------------------|-------------------------------------------------------------------------------------------|
| Глобальная балансировка                    | Geo-based DNS            | 3 пары Active-Active ДЦ  | Развёртывание в трёх географических регионах            | Автоматическое перенаправление трафика на ближайший доступный ДЦ при сбое                 |
| Балансировщики L7                          | NGINX                    | N+1 на ДЦ                | Горизонтальное масштабирование, Health Checks           | Kubernetes автоматически перезапускает или заменяет неисправные ноды                      |
| Микросервисы                               | Kubernetes               | $\ge 3$ реплик на сервис | Liveness/Readiness Probes                               | Самовосстановление подов, роллинг-обновления с Pod Disruption Budgets (PDB)               |
| Объектное хранилище                        | S3-совместимое хранилище | Избыточность данных      | Гео-репликация данных между регионами                   | Восстановление данных из избыточности или реплики в соседнем ДЦ                           |
| Таблицы Users, Pins, Boards, Tags, Follows | PostgreSQL + Patroni     | 1 реплика на шард (RF=2) | Синхронные (внутри ДЦ) и асинхронные (между ДЦ) реплики | Автоматический failover мастера с помощью Patroni/Keeper. Чтение переключается на реплики |
| Таблицы Pin_Boards, Pin_Tags, Pin_Likes    | Cassandra Cluster        | 1 реплика на шард (RF=2) | Встроенный peer-to-peer механизм репликации             | Толерантность к сбою 1 ноды, Восстановление данных через Hinted Handoff                   |
| Поисковый индекс                           | Elasticsearch Cluster    | 1 реплика на шард        | Дублирование данных через реплики шардов                | Автоматическое перераспределение первичных и реплика-шардов на оставшихся живых нодах     |
| Кэш ленты и поиска                         | Redis Cluster            | 1 реплика на мастер-ноду | Использование механизма Sentinel                        | Автоматический failover с выбором нового мастера и промоутом реплики                      |
| Аналитика пинов                            | ClickHouse               | 1 реплика на шард (RF=2) | Реплицируемые таблицы на базе Zookeeper                 | Автоматическая синхронизация и восстановление данных через Zookeeper                      |
| TensorFlow Serving                         | Kubernetes Deployment    | Минимум 2 реплики        | Резервирование вычислительных мощностей                 | Автоматический перезапуск подов. Модели загружаются в память и не имеют состояния         |


## Схема проекта

![Схема проекта](https://github.com/user-attachments/assets/15533983-7414-4d95-81da-41efbc894047)

### Балансировка

#### Уровень L7
Этот уровень обрабатывает трафик, поступающий извне в Kubernetes-кластер, и маршрутизирует его к нужным микросервисам.

Компонент: NGINX

Алгоритмы:
- Least Connections: Направление запроса к тому поду, который имеет наименьшее количество активных соединений

Дополнительные Функции: NGINX также выполняет SSL Termination, Rate Limiting и агрегацию логов перед тем, как передать запрос вглубь кластера

#### Уровень L4
Этот уровень отвечает за балансировку трафика между конкретными подами, принадлежащими одному и тому же Service

Компонент: Kubernetes Service и kube-proxy

Механизм: Когда запрос попадает на Kubernetes Service (через NGINX или от другого внутреннего микросервиса), kube-proxy (работающий на каждой ноде) использует правила iptables для перенаправления TCP/IP трафика

Самовосстановление: kube-proxy автоматически отслеживает состояние подов. Если под падает или не проходит Readiness Probe, он мгновенно удаляется из списка доступных конечных точек, и трафик перестает на него направляться. Это гарантирует, что запросы идут только на здоровые инстансы

Балансировка ML-сервиса: Например, Feed Service обращается к ML Service. Здесь балансировку между подами ML Service обеспечивает именно Kubernetes Service.

### Список серверов и распределение ресурсов

Для обслуживания аудитории в 522M MAU и пиковой нагрузки в ~166 560 RPS выбрана модель развертывания с использованием трех пар Active-Active дата-центров

- Stateless-сервисы (Feed, Read, Write, Search) размещаются в кластерах Kubernetes (k8s) для автоматического масштабирования
- Stateful-сервисы (СУБД, кэши, поисковый индекс, объектное хранилище) развертываются на выделенных физических серверах для обеспечения максимальной производительности I/O и хранения

### Расчет ресурсов для микросервисов (Stateless)

Общая пиковая нагрузка системы составляет  ~167000 RPS. Для расчета CPU: 1 ядро ~100 RPS для большинства сервисов

| Сервис          | Назначение                      | Пиковый RPS (x3) | CPU    | RAM (GB) |
|-----------------|---------------------------------|------------------|--------|----------|
| PinReadService  | Просмотр пинов                  | 3000             | 30     | 60       |
| PinWriteService | Оценка, создание пинов          | 16500            | 165    | 165      |
| ImageProcessing | Оптимизация, превью, CLIP       | -                | 100    | 200      |
| FeedService     | Формирование ленты              | 54000            | 540    | 540      |
| SearchService   | Поиск пинов                     | 15000            | 150    | 150      |
| BoardService    | Создание, редактирование досок  | 25000            | 250    | 250      |
| FollowsService  | Подписки                        | 1000             | 10     | 10       |
| MlService       | Система рекомендаций            | 5000             | 50     | 100      |

### Аллокация ресурсов в Kubernetes (Stateless)

| Сервис          | CPU Request | CPU Limit | RAM Request | RAM Limit | Replicas |
|-----------------|-------------|-----------|-------------|-----------|----------|
| PinReadService  | 30          | 45        | 60          | 90        | 6        |
| PinWriteService | 165         | 250       | 165         | 250       | 33       |
| ImageProcessing | 100         | 150       | 200         | 300       | 20       |
| FeedService     | 540         | 810       | 540         | 810       | 108      |
| SearchService   | 150         | 225       | 150         | 225       | 30       |
| BoardService    | 250         | 375       | 250         | 375       | 50       |
| FollowsService  | 10          | 15        | 10          | 15        | 2        |
| MlService       | 50          | 75        | 100         | 150       | 10       |

### Таблица серверов (Stateful и Infra)
| Тип сервера            | Конфигурация (CPU/RAM/Storage) | Роль/Сервисы             | Общее Кол-во Нод | Кол-во Нод в ДЦ |
|------------------------|--------------------------------|--------------------------|------------------|-----------------|
| Kubernetes Worker Node | 64C / 256GB / 2TB SSD          | Микросервисы             | 24               | 4               |
| Kubernetes Master Node | 16C / 64GB / 500GB SSD         | Control Plane, etcd      | 18               | 3               |
| DB/Compute Node        | 48C / 192GB / 4TB SSD          | Базы данных              | 24               | 4               |
| Cache/Infra Node       | 32C / 128GB / 1TB SSD          | Redis Cluster, NGINX     | 18               | 3               |
| Объектное хранилище    | 32C / 128GB / 5000TB HDD       | S3-совместимое хранилище | 156              | 26              |


Распределение аудитории:  
https://s204.q4cdn.com/369458543/files/doc_earnings/2025/q2/presentation/2025-Q2-IR-Earnings-Presentation.pdf   

Статистические данные:  
https://adamconnell.me/pinterest-statistics/  

Pinterest Investor Relations:
https://investor.pinterestinc.com/news-and-events/press-releases/press-releases-details/2025/Pinterest-Announces-Second-Quarter-2025-Results-Delivers-17-Revenue-Growth-and-Record-Users/default.aspx
