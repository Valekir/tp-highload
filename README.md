# Pinterest
Pinterest — социальный интернет-сервис, фотохостинг, который позволяет пользователям находить, сохранять и выкладывать изображения и видео. 

## Аудитория
MAU - 522М  
DAU - 142M

| **Страна**               | **Количество пользователей (в миллионах)** |
|--------------------------|--------------------------------------------|
| США                      | 89.9                                       |
| Бразилия                 | 38.9                                       |
| Мексика                  | 24.7                                       |
| Германия                 | 19.3                                       |
| Франция                  | 17.3                                       |
| Остальные страны         | 331.9                                      |

## Основной функционал
- Создание пинов
- Оценка пинов
- Создание досок
- Организация пинов на досках
- Просмотр ленты
- Поиск
- Регистрация/авторизация
- Подписка на пользователя

## Продуктовые метрики

| **Метрика**                | **Значение**                             |
|----------------------------|------------------------------------------|
| Создание новых пинов       | 1.5 млрд в неделю                        |
| Всего создано пинов        | >500 млрд                                |
| Всего создано досок        | >10 млрд                                 |
| Время в приложении в месяц | 1 час 49 минут                           |
| Время в приложении в день  | 2 минуты 11 секунд                       |
| Рост аудитории             | 11% с 2024 по 2025 год                   |
| Ежедневная аудитория       | 27.2% от MAU                             |


## Расчет нагрузки

### RPS
~220 пинов за сессиию в 2 минуты<br>
20 пинов за один запрос<br>
~1 новая доска в месяц (некоторые пользователи создают часто, некоторые вообще не создают новые)<br>
Переход на страницу для 1 из 20 пинов<br>
3 Поиска за сессию<br>

| **Запрос**               | **RPS**                         |
|--------------------------|---------------------------------|
| Запрос пинов для ленты   | (142m * 220/20) / 86400 = 18000 |
| Создание нового пина     | (1.5b / 7) / 86400 = 2480       |
| Создание новой доски     | (522m / 30) / 86400 = 200       |
| Добавление пина на доску | (142m * 5) / 86400 = 8220       |
| Оценка пина              | (142m * 2) / 86400 = 3290       |
| Подписка на пользователя | (522m / 30) / 86400 = 200       |
| Переход на страницу пина | (142m * 220/20) / 86400 = 18000 |
| Поиск                    | (142m * 3) / 86400 = 4930       |

### Нагрузка на сеть
Картинки хранятся в оптимизированном виде, их размер в среднем 150 Кб. На практике для ленты отдаются только превью картинок со средним размером ~10 Кб<br>
До оптимизации средний размер картинки ~1.5 Мб<br>
Поиск несет такую же нагрузку, как и основная лента, т.е. также загружает по 20 превью картинок

| **Запрос**               | **Объем трафика (Гбит/с)** |
|--------------------------|----------------------------|
| Запрос пинов для ленты   | 18000 * 10 Кб * 20 = 29.5  |
| Переход на страницу пина | 18000 * 150 Кб = 22.1      |
| Создание нового пина     | 2480 * 1.5 Мб = 31.2       |
| Создание новой доски     | 200 * 2 Кб = 0.003         |
| Добавление пина на доску | 8220 * 2 Кб = 0.135        |
| Оценка пина              | 3290 * 1 Кб = 0.027        |
| Подписка на пользователя | 200 * 1 Кб = 0.001         |
| Поиск                    | 4930 * 10 Кб * 20 = 8.1    |
| Суммарная нагрузка       | 91 Гбит/с                  |


### Занятое место на диске

Картинки хранятся в оришинальном и сжатом виде, поэтому одна картинка занимает 150 Кб + 1.5 Мб
| **Сущность** | **Объем**                 |
|--------------|---------------------------|
| Пины         | 500b * 1.65Мб = 768 ПТб   |
| Доски        | 10b * 100 Кб = 931 Тб     |
| Пользователи | 600M * 100 Кб = 56 Тб     |

## Глобальная балансировка нагрузки

Весь функционал распологается на основном домене pinterest.com

### Расположение датацентров
| Расположение ДЦ 1               | Расположение ДЦ 2     | Покрываемые регионы | Доля пользователей | Обоснование                                                                                       |
|---------------------------------|-----------------------|---------------------|--------------------|---------------------------------------------------------------------------------------------------|
| Ашберн, Северная Вирджиния, США | Даллас, Техас, США    | Северная Америка    | ~23.5%             | Второй по количеству пользователей рынок, первый по среднему доходу с пользователя                |
| Амстердам, Нидерланды           | Франкфурт, Германия   | Страны Европы       | ~26%               | Первый по размеру рынок, средний доход с пользователя выше, чем в остальном мире (за вычетом США) |
| Сан-Паулу, Бразилия             | Сингапур              | Остальные регионыы  | ~50.5%             | Минимальная задержка в регионах с большой долей рынка, но низкой прибылью                         |

### Схема балансировки DNS

Логичнее всего будет использовать Geo-based DNS балансировку, для обеспечения наибольшей надежности и низкой задержки в основных регионах

## Локальная балансировка нагрузки

Суммарный RPS: 18,000 + 2,480 + 200 + 8,220 + 3,290 + 200 + 18,000 + 4,930 = 55,520 RPS<br>
Пиковый RPS: 55,520 × 3 = 166,560 RPS (коэффициент пиковой нагрузки)<br>
Пиковый трафик: 91 Гбит/с × 3 = 273 Гбит/с<br>


Для оркестрации контейнеров и управления жизненным циклом сервисов используем Kubernetes.<br>
При запуске нового экземпляра сервиса Kubernetes создаёт контейнер и проверяет с помощью health check. Если контейнер падает или перестаёт отвечать, Kubernetes перезапускает его. Auto Scaling на основе метрик (CPU, памяти, custom metrics) динамически масштабирует количество подов.


Будем использовать балансировку на уровне приложений (L7) через NGINX как основной механизм распределения внешнего HTTP/HTTPS-трафика к сервисам в Kubernetes-кластере (в кластере работает стандартный балансировщик L4).

NGINX обеспечивает:
- SSL терминацию (через session tickets)
- Решение проблемы медленного клиента
- API-gateway функциональность
- Балансировку нагрузки Round Robin/Least Connections
- Сбор логов и timeout на 99.9%
- Rate limiting и защиту от DDoS


### Расчет количества балансировщиков:

По данным NGINX: 2 × Xeon 2699v4 обрабатывают ~9,871 RPS для запросов 100Кб.
Пиковый RPS на дата-центр: 166,560 / 6 ≈ 27,760 RPS

Требуется нод: 27,760 / 9,871 ≈ 3 рабочих ноды
С резервированием N+1: 4 ноды на дата-центр


## Логическая схема БД

![Диаграмма без названия](https://github.com/user-attachments/assets/7ffe25e1-d13c-41c8-b79e-a8813b8e5e81)

### Описание таблиц и нагрузок

| Таблица       | Назначение             | Размер строки | QPS чтение | QPS запись | Консистентность | Особенности нагрузки     |
|---------------|------------------------|---------------|------------|------------|-----------------|--------------------------|
| Users         | Профили пользователей  | 2 Кб          | 10000      | 500        | Strong          | Популярные пользователи  |
| Pins          | Данные пинов           | 2 Кб          | 100000     | 3000       | Strong          | Горячие пины             |
| Boards        | Доски пользователей    | 2 Кб          | 50000      | 200        | Strong          | Распределение по user_id |
| Tags          | Словарь тегов          | 500 Б         | 100000     | 200        | Strong          | Популярные теги          |
| Pin_Boards    | Связь пинов с досками  | 100 Б         | 50000      | 10000      | Eventual        | Связь с чтением досок    |
| Pin_Tags      | Связь пинов с тегами   | 100 Б         | 40000      | 5000       | Eventual        | Популярные теги (тренды) |
| Pin_Likes     | Лайки пинов            | 100 Б         | 100000     | 5000       | Eventual        | Связь с горячими пинами  |
| Pin_Analytics | Аналитика просмотров   | 500 Б         | 30000      | 100000     | Eventual        | Агрегация данных         |
| Follows       | Подписки пользователей | 100 Б         | 20000      | 200        | Eventual        | Двунаправленные связи    |
| Search_Index  | Поисковый индекс       | 2 Кб          | 100000     | 5000       | Eventual        | Векторные эмбеддинги     |
| Search_Cache  | Кэш поиска             | 2 Кб          | 300000     | 100000     | Eventual        | TTL-инвалидация          |


## Физическая схема БД

| Таблица       | СУБД          | Индексы                     | Балансировка нагрузки |
|---------------|---------------|-----------------------------|-----------------------|
| Users         | PostgreSQL    | user_id, email, username    | pgbouncer             |
| Pins          | PostgreSQL    | pin_id, user_id, created_at | pgbouncer             |
| Boards        | PostgreSQL    | board_id, user_id           | pgbouncer             |
| Tags          | PostgreSQL    | tag_id, tag, usage_count    | pgbouncer             |
| Pin_Boards    | Cassandra     | pin_id, board_id            | partition key         |
| Pin_Tags      | Cassandra     | pin_id, tag_id              | partition key         |
| Pin_Likes     | Cassandra     | pin_id, user_id             | partition key         |
| Pin_Analytics | Clickhouse    | pin_id, date                | distributed движок    |
| Follows       | PostgreSQL    | follower_id, following_id   | pgbouncer             |
| Search_Index  | Elasticsearch | по всем полям               | coordinating nodes    |
| Search_Cache  | Redis         | -                           | redis cluster         |
| Session       | PostgreSQL    | user_id                     | pgbouncer             |

### Схема шардинга и репликации

| Таблица       | Схема шардинга     | Количество реплик |
|---------------|--------------------|-------------------|
| Users         | user_id (range)    | 2                 |
| Pins          | pin_id (range)     | 2                 |
| Boards        | user_id (hash)     | 2                 |
| Tags          | tag_id (hash)      | 2                 |
| Pin_Boards    | (pin_id, board_id) | RF=3              |
| Pin_Tags      | (pin_id, tag_id)   | RF=3              |
| Pin_Likes     | (pin_id, user_id)  | RF=3              |
| Pin_Analytics | (pin_id, date)     | 2                 |
| Follows       | follower_id (hash) | 2                 |
| Search_Index  | pin_id (hash)      | 1                 |
| Search_Cache  | cache_key (hash)   | 1                 |
| Session       | user_id (hash)     | 2                 |


## Алгоритмы

| Алгоритм                 | Описание                                                                                             |
|--------------------------|------------------------------------------------------------------------------------------------------|
| Рекомендательная система | Алгоритм машинного обучения (например, коллаборативная фильтрация или контентная фильтрация)         |
| Алгоритмы ранжирования   | Ранжирование пинов в ленте на основе взаимодействий пользователей (например, CTR, лайки, сохранения) |
| Обработка изображений    | Алгоритмы оптимизации и сжатия изображений (например, JPEG/WebP)                                     |
| Векторный поиск          | Генерация эмбеддингов изображений и текста для семантического поиска                                 |

### Применение алгоритмов

#### Рекомендательная система
Используется для подбора наиболее привлекательных для пользователя картинок. Используется два принципа - коллаборативная фильтрация, т.е. подбор контента на основе того, что нравится людям, на которых пользователь подписан, а также контентная фильтрация - подбор контента на основе того, что уже понравилось пользователю, то есть его лайках, сохранениях и кликах

#### Алгоритмы ранжирования
Чтобы снизить нагрузку на рекомендательную систему она будет возвращать кратно большее количество подходящих пинов (к примеру для ленты будет отдаваться не 20, а 100 пинов за раз), а алгортим ранжирования будет выбирать наиболее подходящие пины. Такой же алгоритм будет использоваться и в поиске

#### Обработка изображений
Для снижения нагрузки на трафик используются современные алгоритмы сжатия изображений. Оригинальные изображения автоматически конвертируются в оптимизированные форматы (WebP/AVIF) с сохранением визуального качества при значительном уменьшении размера файла. Также генерируются превью разных размеров для различных сценариев использования - миниатюры для ленты, средние размеры для страниц пинов и оригиналы для детального просмотра.

#### Векторный поиск 
Используется для семантического поиска по визуальному контенту. Алгоритмы компьютерного зрения анализируют изображения и преобразуют их в векторные представления (эмбеддинги), которые описывают особенности контента. Это позволяет находить визуально похожие пины даже без текстовых описаний, а также комбинировать текстовые и визуальные запросы для более точного поиска. Алгоритм учитывает цветовые схемы, композицию, стиль и объекты на изображениях.

## Технологии
## Технологии

| Технология         | Область применения                          | Обоснование выбора                                                                                     |
|--------------------|---------------------------------------------|--------------------------------------------------------------------------------------------------------|
| PostgreSQL         | Основные данные (пользователи, пины, доски) | ACID-транзакции, надежность, богатый функционал SQL для сложных запросов                               |
| Cassandra          | Связующие таблицы (лайки, теги, пины-доски) | Линейная масштабируемость, высокая доступность, отказоустойчивость для данных с eventual consistency   |
| Redis              | Кэширование поиска и сессий                 | In-memory производительность, низкая задержка (<1ms), поддержка TTL для кэширования                    |
| Elasticsearch      | Поисковый индекс                            | Полнотекстовый поиск, высокая скорость индексации и поиска                                             |
| ClickHouse         | Аналитика просмотров                        | Колоночная СУБД, высокая скорость агрегации больших объемов данных аналитики                           |
| FAISS              | Векторный поиск                             | Оптимизированные алгоритмы поиска ближайших соседей для семантического поиска по эмбеддингам           |
| TensorFlow Serving | ML модели рекомендаций                      | Высокопроизводительное обслуживание моделей, канареечные деплои, версионирование                       |
| Graphite/Grafana   | Мониторинг и метрики                        | Полнофункциональный мониторинг, богатые возможности визуализации, интеграция с Kubernetes              |
| PGBouncer          | Connection pooling для PostgreSQL           | Снижение нагрузки на БД, эффективное управление соединениями для высоких QPS                           |
| FFMPEG             | Сжатие изображений                          | Современные форматы с лучшим качеством/размером, поддержка прозрачности и анимации                     |
| CLIP               | Генерация эмбеддингов                       | Мультимодальная модель для совместного эмбеддинга изображений и текста                                 |
| Docker             | Контейнеризация приложений                  | Стандартизация деплоя, изоляция окружений, быстрое развертывание                                       |
| Kubernetes         | Оркестрация микросервисов                   | Автоматическое масштабирование, self-healing, эффективное управление ресурсами                         |
| NGINX              | L7 балансировщик нагрузки                   | Высокая производительность, SSL termination, API gateway, защита от DDoS                               |




## Источники
Распределение аудитории:  
https://s204.q4cdn.com/369458543/files/doc_earnings/2025/q2/presentation/2025-Q2-IR-Earnings-Presentation.pdf   

Статистические данные:  
https://adamconnell.me/pinterest-statistics/  

Pinterest Investor Relations:
https://investor.pinterestinc.com/news-and-events/press-releases/press-releases-details/2025/Pinterest-Announces-Second-Quarter-2025-Results-Delivers-17-Revenue-Growth-and-Record-Users/default.aspx
